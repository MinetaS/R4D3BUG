# CVE-2017-7533



#### 

## Diff

#### from fsnotify\_oldname\_init

#### to take\_dentry\_name\_snapshot

```c
#if defined(CONFIG_FSNOTIFY)    /* notify helpers */
/*
 * fsnotify_oldname_init - save off the old filename before we change it
 */
static inline const unsigned char *fsnotify_oldname_init(const unsigned char *name)
{
    return kstrdup(name, GFP_KERNEL);
}
#else    /* CONFIG_FSNOTIFY */
static inline const char *fsnotify_oldname_init(const unsigned char *name)
{
    return NULL;
}
#endif    /*  CONFIG_FSNOTIFY */
#endif    /* _LINUX_FS_NOTIFY_H */
/////////////////////////////////////////////////////////
void take_dentry_name_snapshot(struct name_snapshot *name, struct dentry *dentry)
{
    spin_lock(&dentry->d_lock);
    if (unlikely(dname_external(dentry))) {
        struct external_name *p = external_name(dentry);
        atomic_inc(&p->u.count);
        spin_unlock(&dentry->d_lock);
        name->name = p->name;
    } else {
        memcpy(name->inline_name, dentry->d_iname, DNAME_INLINE_LEN);
        spin_unlock(&dentry->d_lock);
        name->name = name->inline_name;
    }
}
EXPORT_SYMBOL(take_dentry_name_snapshot);
```

from fsnotify\_oldname\_free 

to release\_dentry\_name\_snapshot

```c
#if defined(CONFIG_FSNOTIFY)    /* notify helpers */
/*
 * fsnotify_oldname_free - free the name we got from fsnotify_oldname_init
 */
static inline void fsnotify_oldname_free(const unsigned char *old_name)
{
    kfree(old_name);
}
#else    /* CONFIG_FSNOTIFY */
static inline void fsnotify_oldname_free(const unsigned char *old_name)
{}
#endif    /*  CONFIG_FSNOTIFY */
#endif    /* _LINUX_FS_NOTIFY_H */
///////////////////////////////////////////////////////////////////////
void release_dentry_name_snapshot(struct name_snapshot *name)
{
    if (unlikely(name->name != name->inline_name)) {
        struct external_name *p;
        p = container_of(name->name, struct external_name, name[0]);
        if (unlikely(atomic_dec_and_test(&p->u.count)))
            kfree_rcu(p, u.head);
    }
}
EXPORT_SYMBOL(release_dentry_name_snapshot);
```

